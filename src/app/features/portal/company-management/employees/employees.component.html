<app-page-layout
  title="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"
  description="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó"
  icon="üë•"
  [actions]="pageActions()">
  
  <!-- Error Message -->
  @if (errorMessage()) {
    <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
      <p class="text-red-800 text-sm">{{ errorMessage() }}</p>
    </div>
  }

  <!-- Filters -->
  <app-filter-section
    [fields]="filterFields()"
    [columns]="1"
    (filterChange)="onFilterChange($event)"
  />

  <!-- Employees Table -->
  <app-data-table
    [columns]="columns"
    [data]="employees()"
    [actions]="actions"
    (sorted)="onSort($event)"
  >
  </app-data-table>

  <!-- Pagination Controls -->
  <div class="flex items-center justify-between mt-4 text-gray-600 dark:text-gray-400">
    <div class="text-sm">
      ‡πÅ‡∏™‡∏î‡∏á {{ (currentPage() - 1) * pageSize() + 1 }} - {{ currentPage() * pageSize() > totalRecords() ? totalRecords() : currentPage() * pageSize() }} ‡∏à‡∏≤‡∏Å {{ totalRecords() }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    </div>
    <div class="flex items-center gap-2">
      <app-glass-button [disabled]="currentPage() === 1" (clicked)="onPageChange(currentPage() - 1)">
        &laquo; ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
      </app-glass-button>
      <span class="font-semibold">‡∏´‡∏ô‡πâ‡∏≤ {{ currentPage() }} ‡∏à‡∏≤‡∏Å {{ totalPages() }}</span>
      <app-glass-button [disabled]="currentPage() === totalPages()" (clicked)="onPageChange(currentPage() + 1)">
        ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ &raquo;
      </app-glass-button>
    </div>
  </div>

  <!-- Add/Edit Modal Form -->
  <app-modal-form
    [isOpen]="showModal()"
    [title]="(editingEmployee() ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà')"
    [fields]="employeeFormFields()"
    [loading]="saving()"
    submitLabel="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"
    cancelLabel="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
    (closed)="closeModal()"
    (submitted)="onFormSubmitted($event)"
    (fieldChange)="onFormFieldChange($event)"
  />

  <!-- Error Message Display -->
  @if (errorMessage() && showModal()) {
    <div class="p-3 bg-red-50 border border-red-200 rounded-lg mt-4">
      <p class="text-sm text-red-800">{{ errorMessage() }}</p>
    </div>
  }

  <!-- Empty State for Employees -->
  @if (employees().length === 0 && !loading()) {
    <app-empty-state
      icon="üë•"
      title="‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"
      description="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤"
      [action]="{
        label: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô',
        icon: '‚ûï',
        variant: 'primary',
        onClick: openAddModal.bind(this)
      }"
    />
  }

  <!-- Delete Confirmation Modal -->
  <app-modal
    [isOpen]="showDeleteModal()"
    title="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö"
    [loading]="deleting()"
    (closed)="closeDeleteModal()"
  >
    <div class="p-4">
      <p class="text-gray-700 dark:text-gray-300 mb-4">
        ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô <strong>{{ deletingEmployee()?.first_name }} {{ deletingEmployee()?.last_name }}</strong> ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
      </p>
      <p class="text-red-600 dark:text-red-400 text-sm mb-4">
        ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ
      </p>
      <div class="flex justify-end gap-2">
        <app-glass-button
          variant="danger"
          [loading]="deleting()"
          (clicked)="confirmDelete()">
          ‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
        </app-glass-button>
        <app-glass-button
          variant="secondary"
          [disabled]="deleting()"
          (clicked)="closeDeleteModal()">
          ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        </app-glass-button>
      </div>
    </div>
  </app-modal>

  <!-- Face Enrollment Modal -->
  <app-modal
    [isOpen]="showFaceEnrollModal()"
    [title]="'‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ - ' + (enrollingEmployee()?.first_name || '') + ' ' + (enrollingEmployee()?.last_name || '')"
    [loading]="enrollingFace()"
    (closed)="closeFaceEnrollModal()"
  >
    <div class="p-4">
      <!-- Mode Selection -->
      <div class="flex justify-center space-x-4 mb-6">
        <button
          type="button"
          (click)="setEnrollmentMode('upload')"
          [class.bg-primary-500]="enrollmentMode() === 'upload'"
          [class.text-white]="enrollmentMode() === 'upload'"
          [class.bg-white]="enrollmentMode() !== 'upload'"
          [class.text-gray-700]="enrollmentMode() !== 'upload'"
          class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 transition-colors flex items-center space-x-2"
        >
          <span>üìÅ</span> <span>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</span>
        </button>
        <button
          type="button"
          (click)="setEnrollmentMode('camera')"
          [class.bg-primary-500]="enrollmentMode() === 'camera'"
          [class.text-white]="enrollmentMode() === 'camera'"
          [class.bg-white]="enrollmentMode() !== 'camera'"
          [class.text-gray-700]="enrollmentMode() !== 'camera'"
          class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 transition-colors flex items-center space-x-2"
        >
          <span>üì∑</span> <span>‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</span>
        </button>
      </div>

      <!-- Upload Mode -->
      @if (enrollmentMode() === 'upload') {
        <div class="mb-4">
          <div class="flex items-center justify-center w-full">
            <label for="dropzone-file" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 dark:hover:bg-gray-800 dark:bg-gray-700 hover:bg-gray-100 dark:border-gray-600 dark:hover:border-gray-500">
              <div class="flex flex-col items-center justify-center pt-5 pb-6">
                <p class="mb-2 text-sm text-gray-500 dark:text-gray-400"><span class="font-semibold">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</span> ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡∏ß‡∏≤‡∏á</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">PNG, JPG (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡πÑ‡∏ü‡∏•‡πå)</p>
              </div>
              <input id="dropzone-file" type="file" class="hidden" accept="image/*" multiple (change)="onFaceFilesSelected($event)" />
            </label>
          </div>
        </div>
      }

      <!-- Camera Mode -->
      @if (enrollmentMode() === 'camera') {
        <div class="mb-4 flex flex-col items-center">
          <div class="relative w-full max-w-md bg-black rounded-lg overflow-hidden aspect-video mb-4">
            <video #videoElement autoplay playsinline class="w-full h-full object-cover"></video>
            <canvas #canvasElement class="hidden"></canvas>
          </div>
          
          <div class="flex items-center gap-4 w-full max-w-md">
            @if (videoDevices().length > 1) {
              <select 
                [ngModel]="selectedVideoDevice()" 
                (ngModelChange)="selectedVideoDevice.set($event); startCamera()"
                class="flex-1 glass-input text-sm"
              >
                @for (device of videoDevices(); track device.deviceId) {
                  <option [value]="device.deviceId">{{ device.label || 'Camera ' + ($index + 1) }}</option>
                }
              </select>
            }
            
            <button
              type="button"
              (click)="captureImage()"
              class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full flex items-center justify-center gap-2"
            >
              <span>üì∏</span> ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û
            </button>
          </div>
        </div>
      }

      <!-- Preview Images -->
      @if (capturedImages().length > 0) {
        <div class="mb-4">
          <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ({{ capturedImages().length }})</p>
          <div class="flex flex-wrap gap-2">
            @for (img of capturedImages(); track $index) {
              <div class="relative group w-20 h-20">
                <img [src]="img" class="w-full h-full object-cover rounded-lg border border-gray-200 dark:border-gray-700" alt="Face preview">
                <button
                  type="button"
                  (click)="removeImage($index)"
                  class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity shadow-sm"
                  title="‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û"
                >
                  √ó
                </button>
              </div>
            }
          </div>
        </div>
      }

      <!-- Error Message -->
      @if (errorMessage() && showFaceEnrollModal()) {
        <div class="p-3 bg-red-50 border border-red-200 rounded-lg mb-4">
          <p class="text-sm text-red-800">{{ errorMessage() }}</p>
        </div>
      }

      <!-- Actions -->
      <div class="flex justify-end gap-2 mt-6">
        <app-glass-button
          variant="primary"
          [loading]="enrollingFace()"
          [disabled]="selectedFiles.length === 0 || enrollingFace()"
          (clicked)="enrollFace()">
          üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </app-glass-button>
        <app-glass-button
          variant="secondary"
          [disabled]="enrollingFace()"
          (clicked)="closeFaceEnrollModal()">
          ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        </app-glass-button>
      </div>
    </div>
  </app-modal>
</app-page-layout>
