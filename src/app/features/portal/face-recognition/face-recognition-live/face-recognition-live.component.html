<div class="min-h-full flex flex-col p-4 md:p-6 space-y-6">
  <!-- Header -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
    <div>
      <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-primary-600 to-secondary-600 dark:from-primary-400 dark:to-secondary-400">
        Live Face Recognition
      </h1>
      <p class="text-gray-500 dark:text-gray-400 mt-1">Real-time face detection and recognition system</p>
    </div>
    <div class="flex items-center gap-3">
        <div class="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/50 dark:bg-gray-800/50 border border-gray-200 dark:border-gray-700 text-sm">
            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
            <span class="text-gray-600 dark:text-gray-300 font-medium">System Online</span>
        </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="grid grid-cols-1 xl:grid-cols-12 gap-6 h-full min-h-0">
    
    <!-- Left: Video Streams (XL: col-span-8 or 9) -->
    <div class="xl:col-span-8 2xl:col-span-9 flex flex-col min-h-0 space-y-4">
      <app-glass-card class="flex-1 flex flex-col overflow-hidden">
        <div class="p-4 border-b border-gray-200/50 dark:border-gray-700/50 flex justify-between items-center bg-white/30 dark:bg-gray-800/30 backdrop-blur-sm">
          <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100 flex items-center gap-2">
            <mat-icon class="text-primary-500">videocam</mat-icon>
            Active Streams
          </h2>
          <app-glass-button variant="secondary" size="sm" (click)="stopAllStreams()" class="text-red-500 hover:text-red-600">
            <mat-icon class="mr-1">stop_circle</mat-icon> Stop All
          </app-glass-button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 auto-rows-fr">
            <!-- Loop through video streams -->
            @for (stream of videoStreams; track stream.id; let i = $index) {
              <div class="relative group rounded-2xl overflow-hidden bg-black/5 dark:bg-black/20 border border-gray-200/50 dark:border-gray-700/50 shadow-inner flex flex-col">
                
                <!-- Video Area -->
                <div class="relative flex-1 bg-black aspect-video flex items-center justify-center overflow-hidden">
                    <!-- Status Badge -->
                    <div class="absolute top-3 left-3 z-10 px-2 py-1 rounded-md bg-black/60 backdrop-blur-md border border-white/10 flex items-center gap-2">
                        <div class="w-1.5 h-1.5 rounded-full" 
                            [class.bg-green-500]="getStreamStatus(i) === 'active'"
                            [class.bg-yellow-500]="getStreamStatus(i) === 'detecting'"
                            [class.bg-gray-500]="getStreamStatus(i) === 'inactive'">
                        </div>
                        <span class="text-xs font-medium text-white uppercase tracking-wider">Stream {{i + 1}}</span>
                    </div>

                    <!-- Video Container Binding -->
                    <div [class]="'w-full h-full relative'" #videoContainer1 *ngIf="i === 0">
                        <ng-container *ngTemplateOutlet="videoContent; context: {$implicit: stream, index: i}"></ng-container>
                        <ng-container *ngTemplateOutlet="overlays; context: {$implicit: stream}"></ng-container>
                    </div>
                    <div [class]="'w-full h-full relative'" #videoContainer2 *ngIf="i === 1">
                        <ng-container *ngTemplateOutlet="videoContent; context: {$implicit: stream, index: i}"></ng-container>
                        <ng-container *ngTemplateOutlet="overlays; context: {$implicit: stream}"></ng-container>
                    </div>
                    <div [class]="'w-full h-full relative'" #videoContainer3 *ngIf="i === 2">
                        <ng-container *ngTemplateOutlet="videoContent; context: {$implicit: stream, index: i}"></ng-container>
                        <ng-container *ngTemplateOutlet="overlays; context: {$implicit: stream}"></ng-container>
                    </div>
                </div>

                <!-- Controls Area -->
                <div class="p-3 bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm border-t border-gray-200/50 dark:border-gray-700/50 flex flex-wrap gap-2 items-center justify-between">
                    <div class="flex-1 min-w-[140px]">
                        <div class="relative">
                            <mat-icon class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 text-sm pointer-events-none scale-75">photo_camera</mat-icon>
                            <select 
                                class="w-full pl-8 pr-3 py-1.5 text-xs rounded-lg bg-gray-100 dark:bg-gray-800 border-none focus:ring-1 focus:ring-primary-500 text-gray-700 dark:text-gray-300"
                                [value]="stream.selectedDeviceId || ''"
                                (change)="onCameraChange($event, i)">
                                <option value="" disabled>Select Camera</option>
                                @for (camera of availableCameras; track trackByCamera($index, camera)) {
                                    <option [value]="camera.deviceId" [selected]="stream.selectedDeviceId === camera.deviceId">
                                        {{ camera.label }}
                                    </option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="flex items-center gap-1.5">
                        <button (click)="toggleCameraState(i)" 
                                [class]="'p-1.5 rounded-lg transition-colors flex items-center justify-center ' + (stream.isActive ? 'bg-red-100 text-red-600 hover:bg-red-200 dark:bg-red-900/30 dark:text-red-400' : 'bg-primary-100 text-primary-600 hover:bg-primary-200 dark:bg-primary-900/30 dark:text-primary-400')">
                            <mat-icon class="text-sm scale-75">{{ !stream.isActive ? 'videocam' : 'videocam_off' }}</mat-icon>
                        </button>
                        
                        <button *ngIf="stream.isActive" (click)="toggleLandmarks(i)"
                                [class]="'p-1.5 rounded-lg transition-colors flex items-center justify-center ' + (stream.showLandmarks ? 'bg-primary-100 text-primary-600 dark:bg-primary-900/30 dark:text-primary-400' : 'bg-gray-100 text-gray-500 dark:bg-gray-800 dark:text-gray-400')">
                            <mat-icon class="text-sm scale-75">visibility</mat-icon>
                        </button>

                        <button *ngIf="stream.isActive" (click)="toggleFullScreen(i)"
                                class="p-1.5 rounded-lg bg-gray-100 text-gray-500 hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-gray-700 transition-colors flex items-center justify-center">
                            <mat-icon class="text-sm scale-75">{{ !stream.isFullscreen ? 'fullscreen' : 'fullscreen_exit' }}</mat-icon>
                        </button>
                    </div>
                </div>
              </div>
            }
          </div>
        </div>
      </app-glass-card>
    </div>

    <!-- Right: Detected Faces Sidebar (XL: col-span-4 or 3) -->
    <div class="xl:col-span-4 2xl:col-span-3 flex flex-col min-h-0">
      <app-glass-card class="h-full flex flex-col overflow-hidden bg-white/60 dark:bg-gray-900/60">
        
        <!-- Stats Header -->
        <div class="p-4 grid grid-cols-3 gap-2 border-b border-gray-200/50 dark:border-gray-700/50 bg-white/30 dark:bg-gray-800/30 backdrop-blur-sm">
            <div class="flex flex-col items-center p-2 rounded-xl bg-primary-50 dark:bg-primary-900/20 border border-primary-100 dark:border-primary-800/30">
                <span class="text-xl font-bold text-primary-600 dark:text-primary-400">{{ stats.totalDetections }}</span>
                <span class="text-[10px] uppercase tracking-wide text-gray-500 dark:text-gray-400 font-medium">Total</span>
            </div>
            <div class="flex flex-col items-center p-2 rounded-xl bg-green-50 dark:bg-green-900/20 border border-green-100 dark:border-green-800/30">
                <span class="text-xl font-bold text-green-600 dark:text-green-400">{{ stats.recognizedFaces }}</span>
                <span class="text-[10px] uppercase tracking-wide text-gray-500 dark:text-gray-400 font-medium">Found</span>
            </div>
            <div class="flex flex-col items-center p-2 rounded-xl bg-orange-50 dark:bg-orange-900/20 border border-orange-100 dark:border-orange-800/30">
                <span class="text-xl font-bold text-orange-600 dark:text-orange-400">{{ stats.totalErrors }}</span>
                <span class="text-[10px] uppercase tracking-wide text-gray-500 dark:text-gray-400 font-medium">Errors</span>
            </div>
        </div>

        <!-- Header Actions -->
        <div class="px-4 py-3 flex justify-between items-center border-b border-gray-200/50 dark:border-gray-700/50">
            <h2 class="text-sm font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide">Recent Detections</h2>
            <button (click)="clearDetectedFaces()" 
                    class="text-xs text-gray-400 hover:text-red-500 transition-colors flex items-center gap-1">
                <mat-icon class="text-sm scale-75">delete</mat-icon> Clear
            </button>
        </div>

        <!-- List -->
        <div class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
            @if (detectedFaces.length === 0) {
                <div class="h-full flex flex-col items-center justify-center text-center p-6 opacity-60">
                    <div class="w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center mb-4 text-gray-400">
                        <mat-icon class="text-3xl scale-125">person_off</mat-icon>
                    </div>
                    <p class="text-gray-500 dark:text-gray-400 text-sm">Waiting for detections...</p>
                </div>
            }

            @for (face of detectedFaces; track trackByFace($index, face)) {
                <div class="group relative bg-white dark:bg-gray-800/80 rounded-xl p-3 border border-gray-100 dark:border-gray-700 shadow-sm hover:shadow-md transition-all duration-200 hover:scale-[1.02]">
                    <div class="flex gap-3">
                        <!-- Face Image -->
                        <div class="relative w-14 h-14 flex-shrink-0">
                            <img [src]="face.image" class="w-full h-full object-cover rounded-lg bg-gray-200 dark:bg-gray-700" alt="Face">
                            <div class="absolute -bottom-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center border-2 border-white dark:border-gray-800"
                                 [ngClass]="face.recognized ? 'bg-green-500' : 'bg-gray-400'">
                                <mat-icon class="text-[10px] text-white scale-75" *ngIf="face.recognized">check</mat-icon>
                                <mat-icon class="text-[10px] text-white scale-75" *ngIf="!face.recognized">question_mark</mat-icon>
                            </div>
                        </div>

                        <!-- Info -->
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <h3 class="font-semibold text-sm text-gray-900 dark:text-gray-100 truncate pr-2">
                                    {{ face.name || 'Unknown Person' }}
                                </h3>
                                <span class="text-[10px] text-gray-400 whitespace-nowrap">{{ formatTimestamp(face.timestamp) }}</span>
                            </div>
                            
                            <div class="mt-1 flex flex-wrap gap-1.5">
                                <span *ngIf="face.gender" class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-blue-50 text-blue-600 dark:bg-blue-900/30 dark:text-blue-300">
                                    {{ getGenderText(face.gender) }}
                                </span>
                                <span *ngIf="face.age" class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-purple-50 text-purple-600 dark:bg-purple-900/30 dark:text-purple-300">
                                    {{ face.age }} yr
                                </span>
                                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300">
                                    Stream {{ face.streamId + 1 }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
      </app-glass-card>
    </div>
  </div>
</div>

<!-- Reusable Templates -->
<ng-template #videoContent let-stream let-index="index">
    @if (!stream.isActive && !stream.isLoading) {
    <div class="absolute inset-0 flex flex-col items-center justify-center text-gray-500 bg-gray-100/10 backdrop-blur-sm">
        <mat-icon class="text-4xl mb-3 opacity-50 scale-150">videocam_off</mat-icon>
        <p class="text-sm font-medium">Camera Disabled</p>
    </div>
    }
    @if (stream.isLoading) {
    <div class="absolute inset-0 flex flex-col items-center justify-center text-primary-400 bg-black/40 backdrop-blur-sm z-20">
        <mat-icon class="text-3xl mb-3 animate-spin">sync</mat-icon>
        <p class="text-sm font-medium animate-pulse">Connecting...</p>
    </div>
    }
</ng-template>

<ng-template #overlays let-stream>
    <div class="absolute inset-0 pointer-events-none overflow-hidden" *ngIf="stream.isActive">
        <!-- Quality Warning -->
        <div class="absolute top-4 left-1/2 -translate-x-1/2 z-20 px-3 py-1.5 bg-yellow-500/90 text-white text-xs rounded-full shadow-lg backdrop-blur-md flex items-center gap-2 animate-fade-in-down" 
             *ngIf="stream.showQualityWarning && stream.imageQuality">
            <mat-icon class="text-sm scale-75">warning</mat-icon>
            <span>{{ stream.imageQuality.feedback }}</span>
        </div>

        <!-- Faces -->
        <ng-container *ngFor="let face of getTrackedFaces(stream); trackBy: trackByFaceId">
            <div class="absolute border-2 transition-all duration-200 ease-out rounded-lg shadow-[0_0_15px_rgba(0,0,0,0.3)]"
                 [class.border-green-500]="face.recognized"
                 [class.border-yellow-400]="!face.recognized && (!face.name || face.name === 'ไม่รู้จัก')"
                 [class.border-red-500]="false"
                 [ngStyle]="getFaceBoxStyle(face, stream)">
                 
                 <!-- Scanning Effect -->
                 <div class="absolute inset-0 overflow-hidden rounded-lg opacity-30" *ngIf="!face.recognized">
                    <div class="w-full h-[20%] bg-gradient-to-b from-transparent via-yellow-400 to-transparent absolute top-0 animate-scan"></div>
                 </div>

                 <!-- Info Tag -->
                 <div class="absolute -top-10 left-1/2 -translate-x-1/2 bg-black/70 backdrop-blur-md text-white text-xs px-3 py-1.5 rounded-full whitespace-nowrap flex items-center gap-2 shadow-lg transition-all duration-300"
                      [class.bg-green-600]="face.recognized"
                      [class.bg-yellow-600]="!face.recognized">
                    <span class="font-semibold">{{ face.name || 'Scanning...' }}</span>
                    <span class="w-px h-3 bg-white/30"></span>
                    <span class="font-mono">{{ (face.confidence * 100) | number:'1.0-0' }}%</span>
                 </div>
            </div>
        </ng-container>
    </div>
</ng-template>