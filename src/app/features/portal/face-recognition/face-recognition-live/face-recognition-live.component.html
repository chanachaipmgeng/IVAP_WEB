<div class="face-recognition-live">
  <!-- Header -->
  <div class="live-header">
    <h1 class="live-title">Face Recognition Live Test</h1>
    <p class="live-description">
      หน้าทดสอบการตรวจจับและจดจำใบหน้าแบบเรียลไทม์
    </p>
  </div>

  <!-- Main Content Grid -->
  <div class="main-grid">
    <!-- Left: Video Streams (3 sections) -->
    <div class="video-streams-section">
      <app-glass-card>
        <div class="section-header">
          <h2>สตรีมวิดีโอสำหรับสแกนหน้า</h2>
          <div class="stream-controls">
            <app-glass-button
              variant="secondary"
              (click)="stopAllStreams()">
              <i class="fas fa-stop"></i>
              หยุดทั้งหมด
            </app-glass-button>
          </div>
        </div>

        <div class="video-streams-grid">
          <!-- Loop through all video streams -->
          @for (stream of videoStreams; track stream.id; let i = $index) {
          <div class="video-stream-card">
            <div class="stream-header">
              <h3>สตรีมวิดีโอ {{i + 1}}</h3>
              <div class="stream-status" [class]="'status-' + getStreamStatus(i)">
                <i class="fas" 
                   [class.fa-circle]="getStreamStatus(i) === 'active'"
                   [class.fa-spinner]="getStreamStatus(i) === 'detecting'"
                   [class.fa-times-circle]="getStreamStatus(i) === 'inactive'"></i>
                <span>{{ getStreamStatus(i) === 'active' ? 'กำลังทำงาน' : 
                        getStreamStatus(i) === 'detecting' ? 'กำลังตรวจจับ' : 'ไม่ทำงาน' }}</span>
              </div>
            </div>
            
            <!-- Dynamic Video Container -->
            <!-- Note: We use ViewChildren/ElementRef in TS, but for HTML we need unique IDs or direct binding -->
            <!-- Since we use ViewChild with static names in TS, we need to map them manually or refactor TS to use ViewChildren -->
            <!-- For now, we will use the existing ViewChild targets based on index -->
            <div [class]="'video-container video-container-' + (i+1)" 
                 #videoContainer1 *ngIf="i === 0">
                 
                 <!-- Content inside is same for all, just referencing stream object -->
                 <ng-container *ngTemplateOutlet="videoContent; context: {$implicit: stream, index: i}"></ng-container>
            </div>
            <div [class]="'video-container video-container-' + (i+1)" 
                 #videoContainer2 *ngIf="i === 1">
                 <ng-container *ngTemplateOutlet="videoContent; context: {$implicit: stream, index: i}"></ng-container>
            </div>
             <div [class]="'video-container video-container-' + (i+1)" 
                 #videoContainer3 *ngIf="i === 2">
                 <ng-container *ngTemplateOutlet="videoContent; context: {$implicit: stream, index: i}"></ng-container>
            </div>

            <!-- Video Controls -->
            <div class="stream-controls-single">
              <div class="camera-dropdown-wrapper">
                <label class="camera-dropdown-label">
                  <i class="fas fa-camera"></i>
                  กล้อง:
                </label>
                <select 
                  class="camera-dropdown"
                  [value]="stream.selectedDeviceId || ''"
                  (change)="onCameraChange($event, i)">
                  @for (camera of availableCameras; track trackByCamera($index, camera)) {
                    <option 
                      [value]="camera.deviceId"
                      [selected]="stream.selectedDeviceId === camera.deviceId">
                      {{ camera.label }}
                    </option>
                  }
                </select>
              </div>
              
              <app-glass-button
                [variant]="stream.isActive ? 'secondary' : 'primary'"
                size="sm"
                (click)="toggleCameraState(i)">
                <i class="fas" [class.fa-video]="!stream.isActive" [class.fa-video-slash]="stream.isActive"></i>
                {{ stream.isActive ? 'ปิดกล้อง' : 'เปิดกล้อง' }}
              </app-glass-button>

              @if (stream.isActive) {
                <app-glass-button
                  variant="secondary"
                  size="sm"
                  (click)="toggleLandmarks(i)">
                  <i class="fas" [class.fa-eye]="stream.showLandmarks" [class.fa-eye-slash]="!stream.showLandmarks"></i>
                  {{ stream.showLandmarks ? 'ซ่อน' : 'แสดง' }} Landmarks
                </app-glass-button>
              }
              @if (stream.isActive) {
                <app-glass-button
                  variant="secondary"
                  size="sm"
                  (click)="toggleFullScreen(i)">
                  <i class="fas" [class.fa-expand]="!stream.isFullscreen" [class.fa-compress]="stream.isFullscreen"></i>
                  {{ stream.isFullscreen ? 'ย่อหน้าจอ' : 'เต็มจอ' }}
                </app-glass-button>
              }
            </div>
          </div>
          }
        </div>
      </app-glass-card>
    </div>

    <!-- Reusable Template for Video Content -->
    <ng-template #videoContent let-stream let-index="index">
        @if (!stream.isActive && !stream.isLoading) {
        <div class="video-placeholder">
            <i class="fas fa-video-slash"></i>
            <p>กล้องถูกปิดใช้งาน</p>
            <p class="hint">กด "เปิดกล้อง" เพื่อเริ่มการทำงาน</p>
        </div>
        }
        @if (stream.isLoading) {
        <div class="video-placeholder">
            <i class="fas fa-circle-notch fa-spin"></i>
            <p>กำลังเชื่อมต่อกล้อง...</p>
        </div>
        }
        
        <!-- Fullscreen Exit Button -->
        @if (stream.isFullscreen) {
        <button
                class="fullscreen-exit-btn"
                (click)="toggleFullScreen(index)">
            <i class="fas fa-compress"></i>
        </button>
        }
    </ng-template>

    <!-- Right: Detected Faces List -->
    <div class="detected-faces-section">
      <app-glass-card>
        <div class="section-header">
          <h2>ใบหน้าที่ตรวจพบ</h2>
          <app-glass-button
            variant="secondary"
            size="sm"
            (click)="clearDetectedFaces()">
            <i class="fas fa-trash"></i>
            ล้างทั้งหมด
          </app-glass-button>
        </div>

        <div class="stats-summary">
          <div class="stat-item">
            <div class="stat-value">{{ stats.totalDetections }}</div>
            <div class="stat-label">ตรวจจับทั้งหมด</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{ stats.recognizedFaces }}</div>
            <div class="stat-label">จดจำได้</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{ stats.totalErrors }}</div>
            <div class="stat-label">ข้อผิดพลาด</div>
          </div>
        </div>

        <div class="detected-faces-list">
          @if (detectedFaces.length === 0) {
            <div class="no-faces">
              <i class="fas fa-user-slash"></i>
              <p>ยังไม่พบใบหน้า</p>
              <p class="hint">เริ่มสตรีมวิดีโอเพื่อเริ่มตรวจจับใบหน้า</p>
            </div>
          }

          @for (face of detectedFaces; track trackByFace($index, face)) {
            <div class="face-item">
              <div class="face-image">
                <img appImageOptimization [ngSrc]="face.image" alt="Detected Face" loading="lazy"/>
                @if (face.recognized) {
                  <div class="recognized-badge">
                    <i class="fas fa-check-circle"></i>
                    <span>จดจำได้</span>
                  </div>
                }
              </div>
              <div class="face-info">
                <div class="face-name">
                  <i class="fas fa-user"></i>
                  <span>{{ face.name || 'ไม่ทราบชื่อ' }}</span>
                </div>
                <div class="face-details">
                  @if (face.gender) {
                    <div class="detail-item">
                      <i class="fas fa-venus-mars"></i>
                      <span>{{ getGenderText(face.gender) }}</span>
                    </div>
                  }
                  @if (face.age) {
                    <div class="detail-item">
                      <i class="fas fa-birthday-cake"></i>
                      <span>{{ face.age }} ปี</span>
                    </div>
                  }
                  <div class="detail-item">
                    <i class="fas fa-video"></i>
                    <span>สตรีม #{{ face.streamId + 1 }}</span>
                  </div>
                </div>
                <div class="face-time">
                  <i class="fas fa-clock"></i>
                  <span>{{ formatTimestamp(face.timestamp) }}</span>
                </div>
              </div>
            </div>
          }
        </div>
      </app-glass-card>
    </div>
  </div>

</div>
