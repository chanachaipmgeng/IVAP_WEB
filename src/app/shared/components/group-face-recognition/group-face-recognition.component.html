<div class="group-face-recognition-container w-full h-full transition-all duration-300" [class]="customClass || ''" role="group" [attr.aria-label]="ariaLabel || 'Group face recognition'">
  <!-- Header -->
  <div class="header flex justify-between items-center mb-6 flex-wrap gap-4">
    <h2 class="title text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-500 m-0 flex items-center gap-3">
      <mat-icon class="text-3xl w-8 h-8 text-purple-400">groups</mat-icon>
      {{ t('group.title') || 'ระบบจดจำใบหน้าหลายคน' }}
    </h2>
    <div class="status-indicator flex items-center gap-2 px-4 py-2 rounded-full bg-white/5 border border-white/10 backdrop-blur-sm shadow-sm"
         [class.bg-success-500/10]="isInitialized"
         [class.border-success-500/20]="isInitialized">
      <span class="status-dot w-2.5 h-2.5 rounded-full bg-slate-500 animate-pulse"
            [class.bg-success-500]="isInitialized"></span>
      <span class="status-text text-sm font-medium text-slate-400" [class.text-success-400]="isInitialized">
        {{ isInitialized ? (t('common.ready') || 'พร้อมใช้งาน') : (t('common.loading') || 'กำลังโหลด...') }}
      </span>
    </div>
  </div>

  <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
    <!-- Left Column: Camera Feed -->
    <div class="xl:col-span-8 space-y-6">
       <app-glass-card class="camera-card overflow-hidden !p-0 border border-white/10 h-full flex flex-col">
          <!-- Controls Toolbar -->
          <div class="camera-controls flex flex-wrap gap-2 p-3 bg-black/40 border-b border-white/5 justify-between items-center backdrop-blur-md">
            <div class="flex gap-2">
               <app-glass-button
                 [variant]="isStreaming ? 'danger' : 'primary'"
                 size="sm"
                 (click)="isStreaming ? stopCamera() : startCamera()"
                 [disabled]="!isInitialized">
                 <mat-icon>{{ isStreaming ? 'videocam_off' : 'videocam' }}</mat-icon>
                 {{ isStreaming ? (t('camera.stop') || 'หยุดกล้อง') : (t('camera.start') || 'เริ่มกล้อง') }}
               </app-glass-button>

               <app-glass-button
                 variant="secondary"
                 size="sm"
                 (click)="toggleDetection()"
                 [disabled]="!isStreaming">
                 <mat-icon>{{ autoDetect ? 'pause' : 'play_arrow' }}</mat-icon>
               </app-glass-button>
               
               <app-glass-button
                 variant="secondary"
                 size="sm"
                 (click)="showLandmarks = !showLandmarks"
                 [disabled]="!isStreaming"
                 [class.bg-primary-500_20]="showLandmarks">
                 <mat-icon>{{ showLandmarks ? 'visibility_off' : 'visibility' }}</mat-icon>
               </app-glass-button>
            </div>
            
            <div class="flex gap-2">
               <app-glass-button
                 variant="secondary"
                 size="sm"
                 (click)="clearRecognizedFaces()"
                 [disabled]="recognizedFaces.length === 0">
                 <mat-icon>delete_sweep</mat-icon>
                 {{ t('common.clear') || 'ล้างค่า' }}
               </app-glass-button>
               <app-glass-button
                 variant="secondary"
                 size="sm"
                 (click)="exportRecognizedFaces()"
                 [disabled]="recognizedFaces.length === 0">
                 <mat-icon>download</mat-icon>
                 {{ t('common.export') || 'ส่งออก' }}
               </app-glass-button>
            </div>
          </div>

          <!-- Video Area -->
          <div class="video-container relative flex-1 bg-black flex items-center justify-center min-h-[480px]">
            <video
              #videoElement
              class="video-element w-full h-full object-contain"
              [class.hidden]="!isStreaming"
              autoplay
              muted
              playsinline>
            </video>
            
            <canvas
              #canvasElement
              class="canvas-overlay absolute top-0 left-0 w-full h-full pointer-events-none z-10"
              [class.hidden]="!isStreaming">
            </canvas>
            
            @if (!isStreaming) {
              <div class="placeholder flex flex-col items-center justify-center p-12 text-slate-500 text-center animate-pulse">
                <div class="w-24 h-24 rounded-full bg-white/5 flex items-center justify-center mb-6 ring-1 ring-white/10">
                  <mat-icon class="text-6xl w-16 h-16 text-slate-600">groups</mat-icon>
                </div>
                <h3 class="text-xl font-semibold text-slate-400 mb-2">{{ t('group.inactive_title') || 'ระบบจดจำกลุ่มยังไม่ทำงาน' }}</h3>
                <p class="m-0 text-slate-500">{{ t('group.inactive_desc') || 'กดปุ่ม "เริ่มกล้อง" เพื่อเริ่มการทำงาน' }}</p>
              </div>
            }

            <!-- Active Scanning Animation -->
            @if (isStreaming && autoDetect && isDetecting) {
               <div class="absolute inset-0 pointer-events-none z-0 opacity-10 bg-gradient-to-r from-transparent via-purple-500/10 to-transparent animate-scan-horizontal"></div>
            }
          </div>
       </app-glass-card>
    </div>

    <!-- Right Column: Results & List -->
    <div class="xl:col-span-4 space-y-6 flex flex-col h-full">
       
       <!-- Stats Summary -->
       <app-glass-card class="shrink-0">
          <div class="flex justify-between items-center mb-4">
             <h3 class="text-lg font-bold text-white m-0 flex items-center gap-2">
                <mat-icon class="text-purple-400">assessment</mat-icon>
                {{ t('stats.session_stats') || 'สถิติเซสชัน' }}
             </h3>
             <span class="text-xs text-slate-400">{{ t('stats.max') || 'สูงสุด' }} {{ maxFaces }} {{ t('stats.faces_unit') || 'คน' }}</span>
          </div>
          
          <div class="grid grid-cols-2 gap-3">
             <div class="bg-white/5 rounded-xl p-3 border border-white/5 flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-400">
                   <mat-icon>face</mat-icon>
                </div>
                <div>
                   <div class="text-2xl font-bold text-white leading-none">{{ currentDetections.length }}</div>
                   <div class="text-xs text-slate-400 mt-1">{{ t('stats.visible') || 'มองเห็น' }}</div>
                </div>
             </div>
             
             <div class="bg-white/5 rounded-xl p-3 border border-white/5 flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-success-500/20 flex items-center justify-center text-success-400">
                   <mat-icon>verified_user</mat-icon>
                </div>
                <div>
                   <div class="text-2xl font-bold text-white leading-none">{{ recognizedFaces.length }}</div>
                   <div class="text-xs text-slate-400 mt-1">{{ t('stats.logged') || 'บันทึกแล้ว' }}</div>
                </div>
             </div>
          </div>
       </app-glass-card>

       <!-- Live Recognition Feed -->
       <app-glass-card class="flex-1 flex flex-col overflow-hidden min-h-[400px]">
          <h3 class="text-lg font-bold text-white m-0 mb-4 flex items-center gap-2 shrink-0">
             <mat-icon class="text-primary-400">history</mat-icon>
             {{ t('group.live_feed') || 'ฟีดข้อมูลสด' }}
             @if (currentRecognitions.length > 0) {
                <span class="ml-auto text-xs px-2 py-1 rounded-md bg-success-500/20 text-success-400 border border-success-500/20 animate-pulse">{{ t('common.live') || 'สด' }}</span>
             }
          </h3>

          <div class="recognition-list flex-1 overflow-y-auto pr-2 space-y-3 custom-scrollbar">
             @if (recognizedFaces.length === 0) {
                <div class="h-full flex flex-col items-center justify-center text-slate-500 opacity-50">
                   <mat-icon class="text-5xl w-12 h-12 mb-2">person_search</mat-icon>
                   <p>{{ t('group.waiting') || 'กำลังรอการตรวจจับ...' }}</p>
                </div>
             }
             
             @for (face of recognizedFaces.slice().reverse(); track face) {
                <div class="p-3 bg-white/5 rounded-xl border border-white/5 hover:bg-white/10 transition-colors flex gap-3 animate-slide-in-right">
                   <!-- Avatar -->
                   <div class="relative shrink-0 w-12 h-12 rounded-full overflow-hidden bg-black ring-1 ring-white/10">
                      @if (face.snapshot) {
                         <img [src]="face.snapshot" class="w-full h-full object-cover">
                      } @else {
                         <div class="w-full h-full flex items-center justify-center text-slate-600">
                            <mat-icon class="text-xl">person</mat-icon>
                         </div>
                      }
                   </div>
                   
                   <!-- Info -->
                   <div class="flex-1 min-w-0">
                      <div class="flex justify-between items-start">
                         <h4 class="text-white font-semibold text-sm truncate pr-2">{{ face.firstName }} {{ face.lastName }}</h4>
                         <span class="text-[10px] text-slate-500 whitespace-nowrap">{{ face.timestamp | date:'HH:mm:ss' }}</span>
                      </div>
                      <div class="flex items-center gap-2 mt-1">
                         <div class="h-1.5 flex-1 bg-white/10 rounded-full overflow-hidden max-w-[60px]">
                            <div class="h-full rounded-full" 
                                 [class.bg-success-500]="face.confidence > 0.8"
                                 [class.bg-warning-500]="face.confidence <= 0.8 && face.confidence > 0.6"
                                 [class.bg-red-500]="face.confidence <= 0.6"
                                 [style.width.%]="face.confidence * 100">
                            </div>
                         </div>
                         <span class="text-xs" 
                               [class.text-success-400]="face.confidence > 0.8"
                               [class.text-warning-400]="face.confidence <= 0.8">
                            {{ (face.confidence * 100) | number:'1.0-0' }}%
                         </span>
                      </div>
                   </div>
                </div>
             }
          </div>
       </app-glass-card>
    </div>
  </div>
</div>